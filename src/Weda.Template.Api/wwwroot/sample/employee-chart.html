<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Chart</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="/js/auth.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
            font-weight: 600;
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .add-root-btn {
            background: white;
            color: #3498db;
            border: 2px dashed #3498db;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 400;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .add-root-btn:hover {
            background: #f0f9ff;
            border-color: #2980b9;
            color: #2980b9;
        }

        .org-chart {
            background: white;
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow-x: auto;
            min-height: 400px;
        }

        /* Tree structure */
        .tree {
            display: flex;
            justify-content: center;
            padding: 20px 0;
        }

        .tree ul {
            padding-top: 20px;
            position: relative;
            display: flex;
            justify-content: center;
        }

        /* Vertical line down from parent ul */
        .tree ul::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            border-left: 2px solid #d1d5db;
            height: 20px;
        }

        .tree li {
            list-style: none;
            text-align: center;
            position: relative;
            padding: 20px 15px 0 15px;
        }

        /* Vertical line up to node */
        .tree li::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            border-left: 2px solid #d1d5db;
            height: 20px;
        }

        /* Horizontal line connecting siblings - default full width */
        .tree li::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            border-top: 2px solid #d1d5db;
            width: 100%;
        }

        /* First child: line from center to right */
        .tree li:first-child::after {
            left: 50%;
            width: 50%;
        }

        /* Last child: line from left to center */
        .tree li:last-child::after {
            left: 0;
            width: 50%;
        }

        /* Only child: no horizontal line */
        .tree li:only-child::after {
            display: none;
        }

        /* Remove lines for root */
        .tree > ul::before {
            display: none;
        }

        .tree > ul > li::before,
        .tree > ul > li::after {
            display: none;
        }

        /* Employee card */
        .employee-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            width: 240px;
            min-height: 280px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            cursor: move;
            transition: all 0.2s ease;
            position: relative;
            display: inline-block;
        }

        .employee-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            border-color: #cbd5e1;
        }

        .employee-card.editing {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            cursor: default;
        }

        .employee-card.dragging {
            opacity: 0.5;
        }

        .employee-card.drag-over {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .card-header {
            position: relative;
            margin-bottom: 15px;
        }

        .card-actions {
            position: absolute;
            top: -10px;
            right: -10px;
            display: flex;
            gap: 5px;
        }

        .card-action-btn {
            background: white;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .card-action-btn:hover {
            border-color: #cbd5e1;
            color: #374151;
        }

        .card-action-btn.delete:hover {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
        }

        .card-action-btn.edit:hover {
            background: #3498db;
            border-color: #3498db;
            color: white;
        }

        .card-action-btn.save {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .card-action-btn.save:hover {
            background: #059669;
        }

        .card-action-btn.cancel {
            background: #6b7280;
            border-color: #6b7280;
            color: white;
        }

        .card-action-btn.cancel:hover {
            background: #4b5563;
        }

        .card-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin: 0 auto 12px;
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            font-weight: 600;
        }

        .card-name {
            font-weight: 600;
            font-size: 1rem;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .card-info {
            font-size: 0.85rem;
            color: #6b7280;
            line-height: 1.6;
        }

        .card-info div {
            margin-bottom: 4px;
        }

        /* Edit mode styles */
        .edit-input {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 6px;
            font-family: inherit;
        }

        .edit-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .edit-select {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 6px;
            font-family: inherit;
        }

        .edit-label {
            display: block;
            font-size: 0.7rem;
            color: #6b7280;
            margin-bottom: 2px;
            text-align: left;
            font-weight: 500;
        }

        .node-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .toggle-btn {
            background: #64748b;
            border: none;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-top: 8px;
        }

        .toggle-btn:hover {
            background: #475569;
        }

        .collapsed > ul {
            display: none;
        }

        .add-subordinate-btn {
            background: white;
            color: #3498db;
            border: 2px dashed #3498db;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 400;
            transition: all 0.2s ease;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-subordinate-btn:hover {
            background: #f0f9ff;
            border-color: #2980b9;
            color: #2980b9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
            font-size: 1.1rem;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid #fecaca;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Organization Chart</h1>

        <div class="controls">
            <button class="add-root-btn" onclick="addRootEmployee()" id="addRootBtn">+</button>
        </div>

        <div class="org-chart">
            <div id="loading" class="loading">Loading...</div>
            <div id="error" class="error" style="display: none;"></div>
            <div id="tree"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1/employees';
        let employees = [];
        let editingEmployeeId = null;
        let draggedEmployeeId = null;
        let collapsedNodes = new Set(); // Track collapsed node IDs

        // Load employees
        async function loadEmployees() {
            try {
                const response = await authFetch(API_BASE);
                if (!response.ok) throw new Error('Failed to load employees');
                employees = await response.json();
                renderTree();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                showError('Failed to load employees: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Render tree
        function renderTree() {
            const treeDiv = document.getElementById('tree');

            // Find root employees (no supervisor)
            const roots = employees.filter(e => !e.supervisorId);

            // Check if adding a new root node
            const isAddingRoot = editingEmployeeId === -1 && window.addingRootNode;

            if (roots.length === 0 && !isAddingRoot) {
                treeDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ‘¥</div>
                        <h3>No employees yet</h3>
                        <p>Click the button above to add the first employee</p>
                    </div>
                `;
                return;
            }

            const tree = document.createElement('div');
            tree.className = 'tree';

            const ul = document.createElement('ul');

            // Add existing root nodes
            roots.forEach(root => {
                ul.appendChild(createTreeNode(root));
            });

            // Add new root card if adding
            if (isAddingRoot) {
                const newLi = document.createElement('li');
                const newNodeContainer = document.createElement('div');
                newNodeContainer.className = 'node-container';
                newNodeContainer.appendChild(createNewCard(null));
                newLi.appendChild(newNodeContainer);
                ul.appendChild(newLi);
            }

            tree.appendChild(ul);
            treeDiv.innerHTML = '';
            treeDiv.appendChild(tree);
        }

        // Create tree node
        function createTreeNode(employee) {
            const li = document.createElement('li');

            // Node container for card and buttons
            const nodeContainer = document.createElement('div');
            nodeContainer.className = 'node-container';

            // Create employee card
            nodeContainer.appendChild(createEmployeeCard(employee));

            // Find subordinates
            const subordinates = employees.filter(e => e.supervisorId === employee.id);

            // Check if we're adding a new subordinate for this employee
            const isAddingSubordinate = editingEmployeeId === -1 && window.newEmployeeSupervisorId === employee.id;

            const hasChildren = subordinates.length > 0 || isAddingSubordinate;

            // Add subordinate button
            const addBtn = document.createElement('button');
            addBtn.className = 'add-subordinate-btn';
            addBtn.innerHTML = '+';
            addBtn.onclick = (e) => {
                e.stopPropagation();
                addSubordinate(employee.id);
            };
            nodeContainer.appendChild(addBtn);

            // Toggle button (only if has children)
            if (hasChildren) {
                // Restore collapsed state
                const isCollapsed = collapsedNodes.has(employee.id);
                if (isCollapsed) {
                    li.classList.add('collapsed');
                }

                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'toggle-btn';
                toggleBtn.innerHTML = isCollapsed ? 'â–¶' : 'â–¼';
                toggleBtn.onclick = (e) => {
                    e.stopPropagation();
                    li.classList.toggle('collapsed');
                    const nowCollapsed = li.classList.contains('collapsed');
                    toggleBtn.innerHTML = nowCollapsed ? 'â–¶' : 'â–¼';
                    // Save collapsed state
                    if (nowCollapsed) {
                        collapsedNodes.add(employee.id);
                    } else {
                        collapsedNodes.delete(employee.id);
                    }
                };
                nodeContainer.appendChild(toggleBtn);
            }

            li.appendChild(nodeContainer);

            // Children
            if (hasChildren) {
                const ul = document.createElement('ul');

                // Add existing subordinates
                subordinates.forEach(sub => {
                    ul.appendChild(createTreeNode(sub));
                });

                // Add new employee card if we're adding a subordinate
                if (isAddingSubordinate) {
                    const newLi = document.createElement('li');
                    const newNodeContainer = document.createElement('div');
                    newNodeContainer.className = 'node-container';
                    newNodeContainer.appendChild(createNewCard(employee.id));
                    newLi.appendChild(newNodeContainer);
                    ul.appendChild(newLi);
                }

                li.appendChild(ul);
            }

            return li;
        }

        // Create employee card (view mode)
        function createEmployeeCard(employee) {
            const card = document.createElement('div');
            card.className = 'employee-card';
            card.draggable = true;
            card.dataset.employeeId = employee.id;
            card.id = `card-${employee.id}`;

            // Get initials for avatar
            const initials = employee.name
                .split(' ')
                .map(n => n[0])
                .join('')
                .toUpperCase()
                .slice(0, 2);

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-actions">
                        <button class="card-action-btn edit" onclick="event.stopPropagation(); editEmployee(${employee.id})" title="Edit">
                            âœŽ
                        </button>
                        <button class="card-action-btn delete" onclick="event.stopPropagation(); deleteEmployee(${employee.id})" title="Delete">
                            Ã—
                        </button>
                    </div>
                </div>
                <div class="card-avatar">${initials}</div>
                <div class="card-name">${employee.name}</div>
                <div class="card-info">
                    <div>${employee.position}</div>
                    <div>${employee.department}</div>
                    <div>${employee.email}</div>
                </div>
            `;

            setupDragAndDrop(card, employee);
            return card;
        }

        // Create employee card (edit mode)
        function createEditCard(employee) {
            const card = document.createElement('div');
            card.className = 'employee-card editing';
            card.id = `card-${employee.id}`;

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-actions">
                        <button class="card-action-btn save" onclick="event.stopPropagation(); saveEmployee(${employee.id})" title="Save">
                            âœ“
                        </button>
                        <button class="card-action-btn cancel" onclick="event.stopPropagation(); cancelEdit()" title="Cancel">
                            Ã—
                        </button>
                    </div>
                </div>
                <div>
                    <label class="edit-label">Name</label>
                    <input type="text" class="edit-input" id="edit-name-${employee.id}" value="${employee.name}" placeholder="Name">

                    <label class="edit-label">Email</label>
                    <input type="email" class="edit-input" id="edit-email-${employee.id}" value="${employee.email}" placeholder="Email">

                    <label class="edit-label">Department</label>
                    <select class="edit-select" id="edit-department-${employee.id}">
                        <option value="Engineering" ${employee.department === 'Engineering' ? 'selected' : ''}>Engineering</option>
                        <option value="Sales" ${employee.department === 'Sales' ? 'selected' : ''}>Sales</option>
                        <option value="Marketing" ${employee.department === 'Marketing' ? 'selected' : ''}>Marketing</option>
                        <option value="HR" ${employee.department === 'HR' ? 'selected' : ''}>HR</option>
                        <option value="Finance" ${employee.department === 'Finance' ? 'selected' : ''}>Finance</option>
                        <option value="Operations" ${employee.department === 'Operations' ? 'selected' : ''}>Operations</option>
                    </select>

                    <label class="edit-label">Position</label>
                    <input type="text" class="edit-input" id="edit-position-${employee.id}" value="${employee.position}" placeholder="Position">
                </div>
            `;

            return card;
        }

        // Create new employee card (add mode)
        function createNewCard(supervisorId) {
            const card = document.createElement('div');
            card.className = 'employee-card editing';
            card.id = 'card-new';

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-actions">
                        <button class="card-action-btn save" onclick="event.stopPropagation(); saveNewEmployee(${supervisorId})" title="Save">
                            âœ“
                        </button>
                        <button class="card-action-btn cancel" onclick="event.stopPropagation(); cancelAdd()" title="Cancel">
                            Ã—
                        </button>
                    </div>
                </div>
                <div>
                    <label class="edit-label">Name</label>
                    <input type="text" class="edit-input" id="new-name" placeholder="Name">

                    <label class="edit-label">Email</label>
                    <input type="email" class="edit-input" id="new-email" placeholder="Email">

                    <label class="edit-label">Department</label>
                    <select class="edit-select" id="new-department">
                        <option value="">Select</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Sales">Sales</option>
                        <option value="Marketing">Marketing</option>
                        <option value="HR">HR</option>
                        <option value="Finance">Finance</option>
                        <option value="Operations">Operations</option>
                    </select>

                    <label class="edit-label">Position</label>
                    <input type="text" class="edit-input" id="new-position" placeholder="Position">

                    <label class="edit-label">Hire Date</label>
                    <input type="date" class="edit-input" id="new-hiredate">
                </div>
            `;

            return card;
        }

        // Setup drag and drop
        function setupDragAndDrop(card, employee) {
            card.ondragstart = (e) => {
                draggedEmployeeId = employee.id;
                card.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            };

            card.ondragend = (e) => {
                card.classList.remove('dragging');
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            };

            card.ondragover = (e) => {
                e.preventDefault();
                if (draggedEmployeeId && draggedEmployeeId !== employee.id) {
                    card.classList.add('drag-over');
                }
            };

            card.ondragleave = (e) => {
                card.classList.remove('drag-over');
            };

            card.ondrop = async (e) => {
                e.preventDefault();
                card.classList.remove('drag-over');

                // A (draggedEmployeeId) is dropped onto B (employee.id)
                // We want B to become A's supervisor
                // Check: is B a descendant of A? If yes, it would create a cycle
                if (draggedEmployeeId && draggedEmployeeId !== employee.id) {
                    if (!isDescendant(draggedEmployeeId, employee.id)) {
                        await updateSupervisor(draggedEmployeeId, employee.id);
                    } else {
                        alert('Cannot move: would create a circular reference');
                    }
                }
            };
        }

        // Edit employee
        function editEmployee(id) {
            if (editingEmployeeId) return; // Already editing

            editingEmployeeId = id;
            const employee = employees.find(e => e.id === id);
            const oldCard = document.getElementById(`card-${id}`);
            const newCard = createEditCard(employee);
            oldCard.parentNode.replaceChild(newCard, oldCard);
        }

        // Cancel edit
        function cancelEdit() {
            renderTree();
            editingEmployeeId = null;
        }

        // Save employee
        async function saveEmployee(id) {
            const employee = employees.find(e => e.id === id);
            const data = {
                name: document.getElementById(`edit-name-${id}`).value,
                email: document.getElementById(`edit-email-${id}`).value,
                department: document.getElementById(`edit-department-${id}`).value,
                position: document.getElementById(`edit-position-${id}`).value,
                status: employee.status || 'Active',
                supervisorId: employee.supervisorId
            };

            if (!data.name || !data.email || !data.department || !data.position) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const response = await authFetch(`${API_BASE}/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Save failed:', response.status, errorText);
                    throw new Error(`Failed to save employee: ${response.status} - ${errorText}`);
                }

                editingEmployeeId = null;
                await loadEmployees();
            } catch (error) {
                showError('Save failed: ' + error.message);
            }
        }

        // Add subordinate
        function addSubordinate(supervisorId) {
            if (editingEmployeeId) return;

            // If node is collapsed, don't add subordinate (user should expand first)
            if (collapsedNodes.has(supervisorId)) {
                // Expand the node first
                collapsedNodes.delete(supervisorId);
            }

            editingEmployeeId = -1; // Mark as adding

            // Store supervisor ID for later use
            window.newEmployeeSupervisorId = supervisorId;

            // Re-render the tree with the new card
            renderTree();
        }

        // Add root employee (independent node)
        function addRootEmployee() {
            if (editingEmployeeId) return;

            editingEmployeeId = -1;
            window.newEmployeeSupervisorId = null; // No supervisor
            window.addingRootNode = true;
            renderTree();
        }

        // Cancel add
        function cancelAdd() {
            editingEmployeeId = null;
            window.newEmployeeSupervisorId = null;
            window.addingRootNode = false;
            renderTree();
        }

        // Save new employee
        async function saveNewEmployee(supervisorId) {
            const data = {
                name: document.getElementById('new-name').value,
                email: document.getElementById('new-email').value,
                department: document.getElementById('new-department').value,
                position: document.getElementById('new-position').value,
                hireDate: document.getElementById('new-hiredate').value,
                supervisorId: supervisorId
            };

            if (!data.name || !data.email || !data.department || !data.position || !data.hireDate) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                console.log('Creating employee with data:', data);
                const response = await authFetch(API_BASE, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Create failed:', response.status, errorText);
                    throw new Error(`Failed to save employee: ${response.status} - ${errorText}`);
                }

                editingEmployeeId = null;
                window.newEmployeeSupervisorId = null;
                window.addingRootNode = false;
                await loadEmployees();
            } catch (error) {
                showError('Save failed: ' + error.message);
            }
        }

        // Check if employee is descendant
        function isDescendant(ancestorId, employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee || !employee.supervisorId) return false;
            if (employee.supervisorId === ancestorId) return true;
            return isDescendant(ancestorId, employee.supervisorId);
        }

        // Update supervisor
        async function updateSupervisor(employeeId, newSupervisorId) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return;

            try {
                const response = await authFetch(`${API_BASE}/${employeeId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name: employee.name,
                        email: employee.email,
                        department: employee.department,
                        position: employee.position,
                        status: employee.status || 'Active',
                        supervisorId: newSupervisorId
                    })
                });

                if (!response.ok) throw new Error('Failed to update supervisor');
                await loadEmployees();
            } catch (error) {
                showError('Failed to update supervisor: ' + error.message);
            }
        }

        // Delete employee
        async function deleteEmployee(id) {
            const hasSubordinates = employees.some(e => e.supervisorId === id);
            if (hasSubordinates) {
                alert('Cannot delete: this employee has subordinates. Please remove or reassign them first.');
                return;
            }

            if (!confirm('Are you sure you want to delete this employee?')) return;

            try {
                const response = await authFetch(`${API_BASE}/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete employee');
                await loadEmployees();
            } catch (error) {
                showError('Delete failed: ' + error.message);
            }
        }

        // Show error
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Initial load
        loadEmployees();
    </script>
</body>
</html>
