<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="WikiGenerator">
    <link rel="stylesheet" href="../wiki.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
</head>
<body>
    <article class="markdown-body">
    <h1 id="api-layer">API Layer 實作指南</h1>
<blockquote>
<p>學習如何建構 REST API 與 NATS Event-Driven Endpoint</p>
</blockquote>
<h2 id="section">概觀</h2>
<p>API Layer 提供 HTTP Endpoint 與 Event-Driven Interface，透過 Mediator 將請求協調至 Application Layer。</p>
<pre><code>src/Weda.Template.Api/
├── Controllers/
│   ├── ApiController.cs
│   ├── EmployeesController.cs
│   └── AuthController.cs
├── EventControllers/
│   └── EmployeesEventController.cs
├── Mapping/
│   └── EmployeeMapper.cs
├── Program.cs
├── IAssemblyMarker.cs
└── WedaTemplateApiModule.cs
</code></pre>
<hr />
<h2 id="rest-controller">1. REST Controller</h2>
<h3 id="base-controller">1.1 Base Controller</h3>
<pre><code class="language-csharp">// 來自 Weda.Core
[ApiController]
[Authorize]
[Route(&quot;api/v{version:apiVersion}/[controller]&quot;)]
public class ApiController : ControllerBase
{
    protected ActionResult Problem(List&lt;Error&gt; errors)
    {
        if (errors.Count == 0)
            return Problem();

        if (errors.All(e =&gt; e.Type == ErrorType.Validation))
            return ValidationProblem(errors);

        return Problem(errors[0]);
    }

    private ActionResult Problem(Error error)
    {
        var statusCode = error.Type switch
        {
            ErrorType.Validation =&gt; StatusCodes.Status400BadRequest,
            ErrorType.NotFound =&gt; StatusCodes.Status404NotFound,
            ErrorType.Conflict =&gt; StatusCodes.Status409Conflict,
            ErrorType.Unauthorized =&gt; StatusCodes.Status401Unauthorized,
            ErrorType.Forbidden =&gt; StatusCodes.Status403Forbidden,
            _ =&gt; StatusCodes.Status500InternalServerError
        };

        return Problem(
            statusCode: statusCode,
            title: error.Code,
            detail: error.Description);
    }

    private ActionResult ValidationProblem(List&lt;Error&gt; errors)
    {
        var modelState = new ModelStateDictionary();

        foreach (var error in errors)
        {
            modelState.AddModelError(error.Code, error.Description);
        }

        return ValidationProblem(modelState);
    }
}
</code></pre>
<h3 id="resource-controller">1.2 Resource Controller</h3>
<pre><code class="language-csharp">[ApiVersion(&quot;1.0&quot;)]
public class EmployeesController : ApiController
{
    private readonly ISender _mediator;

    public EmployeesController(ISender mediator)
    {
        _mediator = mediator;
    }

    /// &lt;summary&gt;
    /// 取得所有員工
    /// &lt;/summary&gt;
    [HttpGet]
    [ProducesResponseType(typeof(List&lt;EmployeeResponse&gt;), StatusCodes.Status200OK)]
    public async Task&lt;IActionResult&gt; ListEmployees(
        CancellationToken cancellationToken)
    {
        var result = await _mediator.Send(
            new ListEmployeesQuery(),
            cancellationToken);

        return result.Match(
            employees =&gt; Ok(employees.Select(EmployeeMapper.ToResponse)),
            Problem);
    }

    /// &lt;summary&gt;
    /// 依 ID 取得員工
    /// &lt;/summary&gt;
    [HttpGet(&quot;{id:int}&quot;)]
    [ProducesResponseType(typeof(EmployeeResponse), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status404NotFound)]
    public async Task&lt;IActionResult&gt; GetEmployee(
        int id,
        CancellationToken cancellationToken)
    {
        var result = await _mediator.Send(
            new GetEmployeeQuery(id),
            cancellationToken);

        return result.Match(
            employee =&gt; Ok(EmployeeMapper.ToResponse(employee)),
            Problem);
    }

    /// &lt;summary&gt;
    /// 建立新員工
    /// &lt;/summary&gt;
    [HttpPost]
    [ProducesResponseType(typeof(EmployeeResponse), StatusCodes.Status201Created)]
    [ProducesResponseType(typeof(ValidationProblemDetails), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status409Conflict)]
    public async Task&lt;IActionResult&gt; CreateEmployee(
        [FromBody] CreateEmployeeRequest request,
        CancellationToken cancellationToken)
    {
        var command = new CreateEmployeeCommand(
            request.Name,
            request.Email,
            request.Department,
            request.Position,
            request.HireDate,
            request.SupervisorId);

        var result = await _mediator.Send(command, cancellationToken);

        return result.Match(
            employee =&gt; CreatedAtAction(
                nameof(GetEmployee),
                new { id = employee.Id },
                EmployeeMapper.ToResponse(employee)),
            Problem);
    }

    /// &lt;summary&gt;
    /// 更新現有員工
    /// &lt;/summary&gt;
    [HttpPut(&quot;{id:int}&quot;)]
    [ProducesResponseType(typeof(EmployeeResponse), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ValidationProblemDetails), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status404NotFound)]
    public async Task&lt;IActionResult&gt; UpdateEmployee(
        int id,
        [FromBody] UpdateEmployeeRequest request,
        CancellationToken cancellationToken)
    {
        var command = new UpdateEmployeeCommand(
            id,
            request.Name,
            request.Department,
            request.Position);

        var result = await _mediator.Send(command, cancellationToken);

        return result.Match(
            employee =&gt; Ok(EmployeeMapper.ToResponse(employee)),
            Problem);
    }

    /// &lt;summary&gt;
    /// 刪除員工
    /// &lt;/summary&gt;
    [HttpDelete(&quot;{id:int}&quot;)]
    [ProducesResponseType(StatusCodes.Status204NoContent)]
    [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status409Conflict)]
    public async Task&lt;IActionResult&gt; DeleteEmployee(
        int id,
        CancellationToken cancellationToken)
    {
        var result = await _mediator.Send(
            new DeleteEmployeeCommand(id),
            cancellationToken);

        return result.Match(
            _ =&gt; NoContent(),
            Problem);
    }

    /// &lt;summary&gt;
    /// 取得員工的下屬
    /// &lt;/summary&gt;
    [HttpGet(&quot;{id:int}/subordinates&quot;)]
    [ProducesResponseType(typeof(List&lt;EmployeeResponse&gt;), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status404NotFound)]
    public async Task&lt;IActionResult&gt; GetSubordinates(
        int id,
        [FromQuery] bool includeIndirect = false,
        CancellationToken cancellationToken = default)
    {
        var result = await _mediator.Send(
            new GetSubordinatesQuery(id, includeIndirect),
            cancellationToken);

        return result.Match(
            subordinates =&gt; Ok(subordinates.Select(EmployeeMapper.ToResponse)),
            Problem);
    }
}
</code></pre>
<h3 id="controller-response">Controller Response 模式</h3>
<pre><code>┌────────────────────────────────────────────────────────────────────┐
│                       Controller Response Flow                     │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  HTTP Request                                                      │
│       ↓                                                            │
│  Map Request → Command/Query                                       │
│       ↓                                                            │
│  Send via Mediator                                                 │
│       ↓                                                            │
│  Receive ErrorOr&lt;T&gt;                                                │
│       ↓                                                            │
│  result.Match(                                                     │
│      success =&gt; Ok/Created/NoContent,                              │
│      errors =&gt; Problem                                             │
│  )                                                                 │
│       ↓                                                            │
│  HTTP Response                                                     │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
</code></pre>
<hr />
<h2 id="nats-event-controller">2. NATS Event Controller</h2>
<h3 id="eventcontroller-base-weda.core">2.1 EventController Base（來自 Weda.Core）</h3>
<pre><code class="language-csharp">[Stream(&quot;stream_name&quot;)]
[Consumer(&quot;consumer_name&quot;)]
[Connection(&quot;bus&quot;)]
public abstract class EventController
{
    public IMediator Mediator { get; internal set; }
    public INatsConnectionProvider NatsProvider { get; internal set; }
    public ILogger Logger { get; internal set; }
    public string Subject { get; internal set; }
    public IReadOnlyDictionary&lt;string, string&gt; SubjectValues { get; internal set; }
}
</code></pre>
<h3 id="event-controller">2.2 實作 Event Controller</h3>
<pre><code class="language-csharp">[Stream(&quot;employees_v1_stream&quot;)]
[Consumer(&quot;employees_v1_consumer&quot;)]
[Connection(&quot;bus&quot;)]
public class EmployeesEventController : EventController
{
    /// &lt;summary&gt;
    /// Request-Reply：依 ID 取得員工
    /// 回傳回應給請求者
    /// &lt;/summary&gt;
    [Subject(&quot;employees.v1.{id}.get&quot;)]
    public async Task&lt;GetEmployeeResponse&gt; GetEmployee(
        GetEmployeeNatsRequest request,
        CancellationToken cancellationToken)
    {
        var id = int.Parse(SubjectValues[&quot;id&quot;]);

        var result = await Mediator.Send(
            new GetEmployeeQuery(id),
            cancellationToken);

        if (result.IsError)
        {
            return new GetEmployeeResponse(
                Success: false,
                Employee: null,
                Error: result.Errors.First().Description);
        }

        return new GetEmployeeResponse(
            Success: true,
            Employee: result.Value,
            Error: null);
    }

    /// &lt;summary&gt;
    /// JetStream Consume：處理員工建立事件
    /// 預設模式 - 持續處理
    /// &lt;/summary&gt;
    [Subject(&quot;employees.v1.created&quot;)]
    public async Task HandleEmployeeCreated(
        CreateEmployeeNatsEvent @event,
        CancellationToken cancellationToken)
    {
        Logger.LogInformation(
            &quot;Processing employee created event: {Id} - {Name}&quot;,
            @event.Id,
            @event.Name);

        // 處理事件
        await ProcessCreatedEventAsync(@event, cancellationToken);
    }

    /// &lt;summary&gt;
    /// JetStream Fetch：批次處理狀態變更
    /// &lt;/summary&gt;
    [Subject(&quot;employees.v1.status-changed&quot;)]
    [ConsumerMode(NatsConsumerMode.Fetch)]
    public async Task HandleStatusChanged(
        EmployeeStatusChangedNatsEvent @event,
        CancellationToken cancellationToken)
    {
        Logger.LogInformation(
            &quot;Processing status change: {Id} {OldStatus} -&gt; {NewStatus}&quot;,
            @event.EmployeeId,
            @event.OldStatus,
            @event.NewStatus);

        await ProcessStatusChangeAsync(@event, cancellationToken);
    }

    /// &lt;summary&gt;
    /// Core Pub-Sub：Fire-and-Forget 通知
    /// &lt;/summary&gt;
    [Subject(&quot;employees.v1.notifications.&gt;&quot;)]
    [DeliveryMode(NatsDeliveryMode.Core)]
    public void HandleNotification(EmployeeNotificationEvent @event)
    {
        Logger.LogInformation(
            &quot;Received notification for employee: {Id}&quot;,
            @event.EmployeeId);

        // Fire-and-Forget 處理
    }

    private async Task ProcessCreatedEventAsync(
        CreateEmployeeNatsEvent @event,
        CancellationToken cancellationToken)
    {
        // 實作
    }

    private async Task ProcessStatusChangeAsync(
        EmployeeStatusChangedNatsEvent @event,
        CancellationToken cancellationToken)
    {
        // 實作
    }
}
</code></pre>
<h3 id="nats-pattern">NATS Pattern 參考</h3>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>回傳類型</th>
<th>Attribute</th>
<th>使用情境</th>
</tr>
</thead>
<tbody>
<tr>
<td>Request-Reply</td>
<td><code>Task&lt;TResponse&gt;</code></td>
<td>預設</td>
<td>同步查詢</td>
</tr>
<tr>
<td>JetStream Consume</td>
<td><code>Task</code>（void）</td>
<td><code>[ConsumerMode(Consume)]</code></td>
<td>持續處理</td>
</tr>
<tr>
<td>JetStream Fetch</td>
<td><code>Task</code>（void）</td>
<td><code>[ConsumerMode(Fetch)]</code></td>
<td>批次處理</td>
</tr>
<tr>
<td>Core Pub-Sub</td>
<td><code>void</code></td>
<td><code>[DeliveryMode(Core)]</code></td>
<td>Fire-and-Forget</td>
</tr>
</tbody>
</table>
<h3 id="subject-template">Subject Template 變數</h3>
<table>
<thead>
<tr>
<th>變數</th>
<th>說明</th>
<th>範例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>{controller}</code></td>
<td>Controller 名稱</td>
<td><code>employees</code></td>
</tr>
<tr>
<td><code>{version}</code></td>
<td>API 版本</td>
<td><code>v1</code></td>
</tr>
<tr>
<td><code>{id}</code></td>
<td>資源識別碼</td>
<td><code>123</code></td>
</tr>
<tr>
<td><code>&gt;</code></td>
<td>Wildcard（任意後綴）</td>
<td><code>notifications.&gt;</code></td>
</tr>
<tr>
<td><code>*</code></td>
<td>單一 Token Wildcard</td>
<td><code>*.created</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="contract">3. Contract</h2>
<h3 id="request-dto">3.1 Request DTO</h3>
<pre><code class="language-csharp">// 在 Contracts Layer
public record CreateEmployeeRequest(
    string Name,
    string Email,
    string Department,
    string Position,
    DateTime HireDate,
    int? SupervisorId);

public record UpdateEmployeeRequest(
    string Name,
    string Department,
    string Position);
</code></pre>
<h3 id="response-dto">3.2 Response DTO</h3>
<pre><code class="language-csharp">public record EmployeeResponse(
    int Id,
    string Name,
    string Email,
    string Department,
    string Position,
    DateTime HireDate,
    string Status,
    int? SupervisorId,
    DateTime CreatedAt,
    DateTime? UpdatedAt);
</code></pre>
<h3 id="swagger">3.3 Swagger 範例</h3>
<pre><code class="language-csharp">public class CreateEmployeeRequestExample
    : IExamplesProvider&lt;CreateEmployeeRequest&gt;
{
    public CreateEmployeeRequest GetExamples()
    {
        return new CreateEmployeeRequest(
            Name: &quot;John Doe&quot;,
            Email: &quot;john.doe@example.com&quot;,
            Department: &quot;Engineering&quot;,
            Position: &quot;Software Engineer&quot;,
            HireDate: DateTime.UtcNow,
            SupervisorId: null);
    }
}
</code></pre>
<hr />
<h2 id="api-mapper">4. API Mapper</h2>
<h3 id="api-layer-mapperly">4.1 用於 API Layer 的 Mapperly</h3>
<pre><code class="language-csharp">[Mapper]
public static partial class EmployeeMapper
{
    public static partial EmployeeResponse ToResponse(EmployeeDto dto);

    public static IEnumerable&lt;EmployeeResponse&gt; ToResponses(
        IEnumerable&lt;EmployeeDto&gt; dtos)
    {
        return dtos.Select(ToResponse);
    }
}
</code></pre>
<h3 id="mapping">Mapping 流程</h3>
<pre><code>Domain Entity
     ↓ (Application Mapper)
EmployeeDto
     ↓ (API Mapper)
EmployeeResponse
     ↓
JSON Response
</code></pre>
<hr />
<h2 id="program.cs">5. Program.cs 設定</h2>
<h3 id="application">5.1 Application 設定</h3>
<pre><code class="language-csharp">var builder = WebApplication.CreateBuilder(args);

// 加入各 Layer
builder.Services
    .AddApplication()
    .AddInfrastructure(builder.Configuration);

// 加入 Weda.Core 及所有功能
builder.Services.AddWedaCore(builder.Configuration, options =&gt;
{
    options.AddMediator(typeof(IApplicationMarker).Assembly);
    options.AddValidators(typeof(IApplicationMarker).Assembly);
    options.AddSwagger();
    options.AddAuthentication();
    options.AddNats();
});

// 加入 API Versioning
builder.Services.AddApiVersioning(options =&gt;
{
    options.DefaultApiVersion = new ApiVersion(1, 0);
    options.AssumeDefaultVersionWhenUnspecified = true;
    options.ReportApiVersions = true;
})
.AddApiExplorer(options =&gt;
{
    options.GroupNameFormat = &quot;'v'VVV&quot;;
    options.SubstituteApiVersionInUrl = true;
});

var app = builder.Build();

// 設定 Pipeline
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();
app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();

// 初始化資料庫
using (var scope = app.Services.CreateScope())
{
    var dbContext = scope.ServiceProvider.GetRequiredService&lt;AppDbContext&gt;();
    await dbContext.Database.EnsureCreatedAsync();
}

app.Run();
</code></pre>
<h3 id="api-module">5.2 API Module</h3>
<pre><code class="language-csharp">public static class WedaTemplateApiModule
{
    public static IServiceCollection AddApi(this IServiceCollection services)
    {
        services.AddControllers();
        services.AddEndpointsApiExplorer();

        return services;
    }
}
</code></pre>
<hr />
<h2 id="authentication-controller">6. Authentication Controller</h2>
<h3 id="auth-endpoint">6.1 Auth Endpoint</h3>
<pre><code class="language-csharp">[ApiVersion(&quot;1.0&quot;)]
[AllowAnonymous]
public class AuthController : ApiController
{
    private readonly IJwtTokenGenerator _tokenGenerator;

    public AuthController(IJwtTokenGenerator tokenGenerator)
    {
        _tokenGenerator = tokenGenerator;
    }

    /// &lt;summary&gt;
    /// 產生驗證 Token
    /// &lt;/summary&gt;
    [HttpPost(&quot;token&quot;)]
    [ProducesResponseType(typeof(AuthResponse), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status401Unauthorized)]
    public IActionResult GetToken([FromBody] GetAuthRequest request)
    {
        // 正式環境應驗證憑證
        if (string.IsNullOrEmpty(request.Email))
        {
            return Problem(
                statusCode: StatusCodes.Status401Unauthorized,
                title: &quot;Invalid credentials&quot;);
        }

        var token = _tokenGenerator.GenerateToken(
            userId: 1,
            email: request.Email,
            roles: [&quot;User&quot;],
            permissions: [&quot;employees:read&quot;, &quot;employees:write&quot;]);

        return Ok(new AuthResponse(token));
    }
}
</code></pre>
<hr />
<h2 id="error-handling">7. Error Handling</h2>
<h3 id="global-exception-handler">7.1 Global Exception Handler</h3>
<pre><code class="language-csharp">// 在 Weda.Core 中設定
app.UseExceptionHandler(errorApp =&gt;
{
    errorApp.Run(async context =&gt;
    {
        context.Response.StatusCode = StatusCodes.Status500InternalServerError;
        context.Response.ContentType = &quot;application/problem+json&quot;;

        var error = context.Features.Get&lt;IExceptionHandlerFeature&gt;();

        if (error != null)
        {
            var problem = new ProblemDetails
            {
                Status = StatusCodes.Status500InternalServerError,
                Title = &quot;An unexpected error occurred&quot;,
                Detail = error.Error.Message
            };

            await context.Response.WriteAsJsonAsync(problem);
        }
    });
});
</code></pre>
<h3 id="problemdetails-response">7.2 ProblemDetails Response</h3>
<pre><code class="language-json">{
  &quot;type&quot;: &quot;https://tools.ietf.org/html/rfc7807&quot;,
  &quot;title&quot;: &quot;Employee.NotFound&quot;,
  &quot;status&quot;: 404,
  &quot;detail&quot;: &quot;Employee not found&quot;,
  &quot;traceId&quot;: &quot;00-abc123-def456-00&quot;
}
</code></pre>
<hr />
<h2 id="section-1">快速參考</h2>
<h3 id="section-2">檔案命名慣例</h3>
<table>
<thead>
<tr>
<th>元件</th>
<th>模式</th>
<th>範例</th>
</tr>
</thead>
<tbody>
<tr>
<td>Controller</td>
<td><code>{Resource}Controller.cs</code></td>
<td><code>EmployeesController.cs</code></td>
</tr>
<tr>
<td>Event Controller</td>
<td><code>{Resource}EventController.cs</code></td>
<td><code>EmployeesEventController.cs</code></td>
</tr>
<tr>
<td>Request</td>
<td><code>{Action}{Resource}Request.cs</code></td>
<td><code>CreateEmployeeRequest.cs</code></td>
</tr>
<tr>
<td>Response</td>
<td><code>{Resource}Response.cs</code></td>
<td><code>EmployeeResponse.cs</code></td>
</tr>
<tr>
<td>Mapper</td>
<td><code>{Resource}Mapper.cs</code></td>
<td><code>EmployeeMapper.cs</code></td>
</tr>
<tr>
<td>Module</td>
<td><code>{Project}ApiModule.cs</code></td>
<td><code>WedaTemplateApiModule.cs</code></td>
</tr>
</tbody>
</table>
<h3 id="section-3">資料夾結構</h3>
<pre><code>Api/
├── Controllers/
│   ├── ApiController.cs
│   └── {Resource}Controller.cs
├── EventControllers/
│   └── {Resource}EventController.cs
├── Mapping/
│   └── {Resource}Mapper.cs
├── Program.cs
├── IAssemblyMarker.cs
└── {Project}ApiModule.cs
</code></pre>
<h3 id="http-status-code">HTTP Status Code</h3>
<table>
<thead>
<tr>
<th>Code</th>
<th>意義</th>
<th>使用時機</th>
</tr>
</thead>
<tbody>
<tr>
<td>200</td>
<td>OK</td>
<td>成功的 GET、PUT</td>
</tr>
<tr>
<td>201</td>
<td>Created</td>
<td>成功的 POST</td>
</tr>
<tr>
<td>204</td>
<td>No Content</td>
<td>成功的 DELETE</td>
</tr>
<tr>
<td>400</td>
<td>Bad Request</td>
<td>驗證錯誤</td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>缺少/無效的驗證</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden</td>
<td>權限不足</td>
</tr>
<tr>
<td>404</td>
<td>Not Found</td>
<td>資源不存在</td>
</tr>
<tr>
<td>409</td>
<td>Conflict</td>
<td>重複或狀態衝突</td>
</tr>
<tr>
<td>500</td>
<td>Server Error</td>
<td>非預期錯誤</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="section-4">相關資源</h2>
<ul>
<li><a href="GUIDE.md">GUIDE.md</a> - 學習指南總覽</li>
<li><a href="03-infrastructure-layer.md">03-infrastructure-layer.md</a> - Infrastructure Layer 指南</li>
<li><a href="https://learn.microsoft.com/aspnet/core/">ASP.NET Core Documentation</a></li>
<li><a href="https://docs.nats.io/">NATS Documentation</a></li>
</ul>

    </article>
</body>
</html>