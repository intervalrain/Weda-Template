<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="WikiGenerator">
    <link rel="stylesheet" href="../wiki.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
</head>
<body>
    <article class="markdown-body">
    <h1 id="application-layer">Application Layer 實作指南</h1>
<blockquote>
<p>學習如何使用 CQRS Pattern 與 Mediator 實作 Use Case</p>
</blockquote>
<h2 id="section">概觀</h2>
<p>Application Layer 負責協調 Domain 操作並實作 Use Case。它依賴 Domain Layer，但不知道 Infrastructure 或 API Layer 的存在。</p>
<pre><code>src/Weda.Template.Application/
├── Common/
│   ├── Behaviors/
│   │   ├── ValidationBehavior.cs
│   │   └── AuthorizationBehavior.cs
│   └── Interfaces/
│       └── IDateTimeProvider.cs
├── Employees/
│   ├── Commands/
│   │   ├── CreateEmployee/
│   │   │   ├── CreateEmployeeCommandHandler.cs
│   │   │   └── CreateEmployeeCommandValidator.cs
│   │   ├── UpdateEmployee/
│   │   └── DeleteEmployee/
│   ├── Queries/
│   │   ├── GetEmployee/
│   │   ├── ListEmployees/
│   │   └── GetSubordinates/
│   ├── EventHandlers/
│   │   └── EmployeeCreatedEventHandler.cs
│   └── Mapping/
│       └── EmployeeMapper.cs
├── WedaTemplateApplicationModule.cs
└── IApplicationMarker.cs
</code></pre>
<hr />
<h2 id="command-query-cqrs">1. Command 與 Query (CQRS)</h2>
<h3 id="command">1.1 Command 定義</h3>
<p>Command 在 Contracts Layer 定義，在 Application Layer 處理。</p>
<pre><code class="language-csharp">// 在 Contracts Layer: Weda.Template.Contracts/Employees/Commands/
public record CreateEmployeeCommand(
    string Name,
    string Email,
    string Department,
    string Position,
    DateTime HireDate,
    int? SupervisorId = null) : IRequest&lt;ErrorOr&lt;EmployeeDto&gt;&gt;;

public record UpdateEmployeeCommand(
    int Id,
    string Name,
    string Department,
    string Position) : IRequest&lt;ErrorOr&lt;EmployeeDto&gt;&gt;;

public record DeleteEmployeeCommand(int Id) : IRequest&lt;ErrorOr&lt;Deleted&gt;&gt;;
</code></pre>
<h3 id="query">1.2 Query 定義</h3>
<pre><code class="language-csharp">// 在 Contracts Layer: Weda.Template.Contracts/Employees/Queries/
public record GetEmployeeQuery(int Id) : IRequest&lt;ErrorOr&lt;EmployeeDto&gt;&gt;;

public record ListEmployeesQuery() : IRequest&lt;ErrorOr&lt;List&lt;EmployeeDto&gt;&gt;&gt;;

public record GetSubordinatesQuery(
    int EmployeeId,
    bool IncludeIndirect = false) : IRequest&lt;ErrorOr&lt;List&lt;EmployeeDto&gt;&gt;&gt;;
</code></pre>
<h3 id="command-vs-query">Command vs Query</h3>
<table>
<thead>
<tr>
<th>面向</th>
<th>Command</th>
<th>Query</th>
</tr>
</thead>
<tbody>
<tr>
<td>目的</td>
<td>變更狀態</td>
<td>讀取資料</td>
</tr>
<tr>
<td>回傳類型</td>
<td><code>ErrorOr&lt;T&gt;</code> 或 <code>ErrorOr&lt;Deleted&gt;</code></td>
<td><code>ErrorOr&lt;TDto&gt;</code> 或 <code>ErrorOr&lt;List&lt;TDto&gt;&gt;</code></td>
</tr>
<tr>
<td>Side Effect</td>
<td>有</td>
<td>無</td>
</tr>
<tr>
<td>資料夾</td>
<td><code>Commands/{ActionName}/</code></td>
<td><code>Queries/{ActionName}/</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="command-handler">2. Command Handler</h2>
<h3 id="create-handler">2.1 Create Handler</h3>
<pre><code class="language-csharp">public class CreateEmployeeCommandHandler
    : IRequestHandler&lt;CreateEmployeeCommand, ErrorOr&lt;EmployeeDto&gt;&gt;
{
    private readonly IEmployeeRepository _employeeRepository;
    private readonly EmployeeHierarchyManager _hierarchyManager;

    public CreateEmployeeCommandHandler(
        IEmployeeRepository employeeRepository,
        EmployeeHierarchyManager hierarchyManager)
    {
        _employeeRepository = employeeRepository;
        _hierarchyManager = hierarchyManager;
    }

    public async Task&lt;ErrorOr&lt;EmployeeDto&gt;&gt; Handle(
        CreateEmployeeCommand request,
        CancellationToken cancellationToken)
    {
        // 1. 建立 Value Object
        var nameResult = EmployeeName.Create(request.Name);
        if (nameResult.IsError)
            return nameResult.Errors;

        var emailResult = Email.Create(request.Email);
        if (emailResult.IsError)
            return emailResult.Errors;

        var departmentResult = Department.Create(request.Department);
        if (departmentResult.IsError)
            return departmentResult.Errors;

        // 2. 檢查 Email 是否重複
        if (await _employeeRepository.ExistsWithEmailAsync(
            emailResult.Value, cancellationToken))
        {
            return EmployeeErrors.DuplicateEmail;
        }

        // 3. 建立 Aggregate
        var employeeResult = Employee.Create(
            nameResult.Value,
            emailResult.Value,
            departmentResult.Value,
            request.Position,
            request.HireDate,
            request.SupervisorId);

        if (employeeResult.IsError)
            return employeeResult.Errors;

        var employee = employeeResult.Value;

        // 4. 驗證 Supervisor（若有提供）
        if (request.SupervisorId.HasValue)
        {
            var assignResult = await _hierarchyManager.AssignSupervisorAsync(
                employee,
                request.SupervisorId.Value,
                cancellationToken);

            if (assignResult.IsError)
                return assignResult.Errors;
        }

        // 5. 持久化
        await _employeeRepository.AddAsync(employee, cancellationToken);

        // 6. 轉換並回傳
        return EmployeeMapper.ToDto(employee);
    }
}
</code></pre>
<h3 id="update-handler">2.2 Update Handler</h3>
<pre><code class="language-csharp">public class UpdateEmployeeCommandHandler
    : IRequestHandler&lt;UpdateEmployeeCommand, ErrorOr&lt;EmployeeDto&gt;&gt;
{
    private readonly IEmployeeRepository _employeeRepository;

    public UpdateEmployeeCommandHandler(IEmployeeRepository employeeRepository)
    {
        _employeeRepository = employeeRepository;
    }

    public async Task&lt;ErrorOr&lt;EmployeeDto&gt;&gt; Handle(
        UpdateEmployeeCommand request,
        CancellationToken cancellationToken)
    {
        // 1. 取得 Entity
        var employee = await _employeeRepository
            .GetByIdAsync(request.Id, cancellationToken);

        if (employee is null)
            return EmployeeErrors.NotFound;

        // 2. 建立 Value Object
        var nameResult = EmployeeName.Create(request.Name);
        if (nameResult.IsError)
            return nameResult.Errors;

        var departmentResult = Department.Create(request.Department);
        if (departmentResult.IsError)
            return departmentResult.Errors;

        // 3. 透過 Domain Method 更新
        var updateResult = employee.UpdateInfo(
            nameResult.Value,
            departmentResult.Value,
            request.Position);

        if (updateResult.IsError)
            return updateResult.Errors;

        // 4. 持久化
        await _employeeRepository.UpdateAsync(employee, cancellationToken);

        // 5. 回傳轉換後的 DTO
        return EmployeeMapper.ToDto(employee);
    }
}
</code></pre>
<h3 id="delete-handler">2.3 Delete Handler</h3>
<pre><code class="language-csharp">public class DeleteEmployeeCommandHandler
    : IRequestHandler&lt;DeleteEmployeeCommand, ErrorOr&lt;Deleted&gt;&gt;
{
    private readonly IEmployeeRepository _employeeRepository;

    public DeleteEmployeeCommandHandler(IEmployeeRepository employeeRepository)
    {
        _employeeRepository = employeeRepository;
    }

    public async Task&lt;ErrorOr&lt;Deleted&gt;&gt; Handle(
        DeleteEmployeeCommand request,
        CancellationToken cancellationToken)
    {
        var employee = await _employeeRepository
            .GetByIdAsync(request.Id, cancellationToken);

        if (employee is null)
            return EmployeeErrors.NotFound;

        // 刪除前檢查業務規則
        var subordinates = await _employeeRepository
            .GetBySupervisorIdAsync(request.Id, cancellationToken);

        if (subordinates.Count &gt; 0)
            return EmployeeErrors.HasSubordinates;

        await _employeeRepository.DeleteAsync(employee, cancellationToken);

        return Result.Deleted;
    }
}
</code></pre>
<h3 id="handler">Handler 流程</h3>
<pre><code>┌────────────────────────────────────────────────────────────────────┐
│                        Command Handler Flow                        │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  1. 接收 Command                                                   │
│         ↓                                                          │
│  2. 建立/驗證 Value Object                                         │
│         ↓                                                          │
│  3. 取得 Entity（若為 Update/Delete）                              │
│         ↓                                                          │
│  4. 執行 Domain Logic                                              │
│         ↓                                                          │
│  5. 使用 Domain Service（若需要）                                  │
│         ↓                                                          │
│  6. 透過 Repository 持久化                                         │
│         ↓                                                          │
│  7. 轉換為 DTO 並回傳                                              │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
</code></pre>
<hr />
<h2 id="query-handler">3. Query Handler</h2>
<h3 id="entity">3.1 取得單一 Entity</h3>
<pre><code class="language-csharp">public class GetEmployeeQueryHandler
    : IRequestHandler&lt;GetEmployeeQuery, ErrorOr&lt;EmployeeDto&gt;&gt;
{
    private readonly IEmployeeRepository _employeeRepository;

    public GetEmployeeQueryHandler(IEmployeeRepository employeeRepository)
    {
        _employeeRepository = employeeRepository;
    }

    public async Task&lt;ErrorOr&lt;EmployeeDto&gt;&gt; Handle(
        GetEmployeeQuery request,
        CancellationToken cancellationToken)
    {
        var employee = await _employeeRepository
            .GetByIdAsync(request.Id, cancellationToken);

        if (employee is null)
            return EmployeeErrors.NotFound;

        return EmployeeMapper.ToDto(employee);
    }
}
</code></pre>
<h3 id="entity-1">3.2 列出 Entity</h3>
<pre><code class="language-csharp">public class ListEmployeesQueryHandler
    : IRequestHandler&lt;ListEmployeesQuery, ErrorOr&lt;List&lt;EmployeeDto&gt;&gt;&gt;
{
    private readonly IEmployeeRepository _employeeRepository;

    public ListEmployeesQueryHandler(IEmployeeRepository employeeRepository)
    {
        _employeeRepository = employeeRepository;
    }

    public async Task&lt;ErrorOr&lt;List&lt;EmployeeDto&gt;&gt;&gt; Handle(
        ListEmployeesQuery request,
        CancellationToken cancellationToken)
    {
        var employees = await _employeeRepository
            .GetAllAsync(cancellationToken);

        return employees.Select(EmployeeMapper.ToDto).ToList();
    }
}
</code></pre>
<h3 id="domain-service-query">3.3 使用 Domain Service 的複雜 Query</h3>
<pre><code class="language-csharp">public class GetSubordinatesQueryHandler
    : IRequestHandler&lt;GetSubordinatesQuery, ErrorOr&lt;List&lt;EmployeeDto&gt;&gt;&gt;
{
    private readonly IEmployeeRepository _employeeRepository;
    private readonly EmployeeHierarchyManager _hierarchyManager;

    public GetSubordinatesQueryHandler(
        IEmployeeRepository employeeRepository,
        EmployeeHierarchyManager hierarchyManager)
    {
        _employeeRepository = employeeRepository;
        _hierarchyManager = hierarchyManager;
    }

    public async Task&lt;ErrorOr&lt;List&lt;EmployeeDto&gt;&gt;&gt; Handle(
        GetSubordinatesQuery request,
        CancellationToken cancellationToken)
    {
        var employee = await _employeeRepository
            .GetByIdAsync(request.EmployeeId, cancellationToken);

        if (employee is null)
            return EmployeeErrors.NotFound;

        var subordinates = request.IncludeIndirect
            ? await _hierarchyManager.GetAllSubordinatesAsync(
                request.EmployeeId, cancellationToken)
            : await _employeeRepository.GetBySupervisorIdAsync(
                request.EmployeeId, cancellationToken);

        return subordinates.Select(EmployeeMapper.ToDto).ToList();
    }
}
</code></pre>
<hr />
<h2 id="validator-fluentvalidation">4. Validator (FluentValidation)</h2>
<h3 id="command-validator">4.1 Command Validator</h3>
<pre><code class="language-csharp">public class CreateEmployeeCommandValidator
    : AbstractValidator&lt;CreateEmployeeCommand&gt;
{
    public CreateEmployeeCommandValidator()
    {
        RuleFor(x =&gt; x.Name)
            .NotEmpty()
            .WithMessage(&quot;Name is required&quot;)
            .MaximumLength(EmployeeName.MaxLength)
            .WithMessage($&quot;Name cannot exceed {EmployeeName.MaxLength} characters&quot;);

        RuleFor(x =&gt; x.Email)
            .NotEmpty()
            .WithMessage(&quot;Email is required&quot;)
            .MaximumLength(Email.MaxLength)
            .WithMessage($&quot;Email cannot exceed {Email.MaxLength} characters&quot;)
            .EmailAddress()
            .WithMessage(&quot;Invalid email format&quot;);

        RuleFor(x =&gt; x.Department)
            .NotEmpty()
            .WithMessage(&quot;Department is required&quot;)
            .MaximumLength(Department.MaxLength)
            .WithMessage($&quot;Department cannot exceed {Department.MaxLength} characters&quot;);

        RuleFor(x =&gt; x.Position)
            .NotEmpty()
            .WithMessage(&quot;Position is required&quot;)
            .MaximumLength(100)
            .WithMessage(&quot;Position cannot exceed 100 characters&quot;);

        RuleFor(x =&gt; x.HireDate)
            .NotEmpty()
            .WithMessage(&quot;Hire date is required&quot;)
            .LessThanOrEqualTo(DateTime.UtcNow)
            .WithMessage(&quot;Hire date cannot be in the future&quot;);
    }
}
</code></pre>
<h3 id="validation-pipeline-behavior">4.2 Validation Pipeline Behavior</h3>
<p>Weda.Core 的 <code>ValidationBehavior</code> 會自動攔截 Request：</p>
<pre><code class="language-csharp">public class ValidationBehavior&lt;TRequest, TResponse&gt;
    : IPipelineBehavior&lt;TRequest, TResponse&gt;
    where TRequest : IRequest&lt;TResponse&gt;
    where TResponse : IErrorOr
{
    private readonly IEnumerable&lt;IValidator&lt;TRequest&gt;&gt; _validators;

    public ValidationBehavior(IEnumerable&lt;IValidator&lt;TRequest&gt;&gt; validators)
    {
        _validators = validators;
    }

    public async Task&lt;TResponse&gt; Handle(
        TRequest request,
        RequestHandlerDelegate&lt;TResponse&gt; next,
        CancellationToken cancellationToken)
    {
        if (!_validators.Any())
            return await next();

        var context = new ValidationContext&lt;TRequest&gt;(request);

        var validationResults = await Task.WhenAll(
            _validators.Select(v =&gt; v.ValidateAsync(context, cancellationToken)));

        var errors = validationResults
            .SelectMany(r =&gt; r.Errors)
            .Where(f =&gt; f is not null)
            .Select(f =&gt; Error.Validation(f.PropertyName, f.ErrorMessage))
            .ToList();

        if (errors.Count &gt; 0)
            return (dynamic)errors;

        return await next();
    }
}
</code></pre>
<hr />
<h2 id="event-handler">5. Event Handler</h2>
<h3 id="domain-event-handler">5.1 Domain Event Handler</h3>
<pre><code class="language-csharp">public class EmployeeCreatedEventHandler
    : INotificationHandler&lt;EmployeeCreatedEvent&gt;
{
    private readonly ILogger&lt;EmployeeCreatedEventHandler&gt; _logger;
    private readonly INatsConnectionProvider _natsProvider;

    public EmployeeCreatedEventHandler(
        ILogger&lt;EmployeeCreatedEventHandler&gt; logger,
        INatsConnectionProvider natsProvider)
    {
        _logger = logger;
        _natsProvider = natsProvider;
    }

    public async Task Handle(
        EmployeeCreatedEvent notification,
        CancellationToken cancellationToken)
    {
        var employee = notification.Employee;

        _logger.LogInformation(
            &quot;Employee created: {Id} - {Name}&quot;,
            employee.Id,
            employee.Name);

        // 發布至 NATS
        var natsEvent = new CreateEmployeeNatsEvent(
            employee.Id,
            employee.Name,
            employee.Email,
            employee.Department,
            employee.CreatedAt);

        await _natsProvider.PublishAsync(
            EmployeeNatsSubjects.Created,
            natsEvent,
            cancellationToken);
    }
}
</code></pre>
<h3 id="event-handler-1">Event Handler 最佳實踐</h3>
<table>
<thead>
<tr>
<th>實踐</th>
<th>說明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Idempotency</td>
<td>Handler 應該可以安全地執行多次</td>
</tr>
<tr>
<td>Async Operation</td>
<td>用於外部整合（NATS、Email 等）</td>
</tr>
<tr>
<td>Error Handling</td>
<td>記錄錯誤，考慮重試機制</td>
</tr>
<tr>
<td>Single Responsibility</td>
<td>每個 Handler 只處理一個 Side Effect</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="mapper">6. Mapper</h2>
<h3 id="mapperly-source-generator">6.1 Mapperly Source Generator</h3>
<pre><code class="language-csharp">[Mapper]
public static partial class EmployeeMapper
{
    public static partial EmployeeDto ToDto(Employee employee);

    // Value Object 的自訂 Mapping
    private static string MapName(EmployeeName name) =&gt; name.Value;
    private static string MapEmail(Email email) =&gt; email.Value;
    private static string MapDepartment(Department dept) =&gt; dept.Value;
    private static string MapStatus(EmployeeStatus status) =&gt; status.ToString();
}
</code></pre>
<h3 id="dto">6.2 DTO 定義</h3>
<pre><code class="language-csharp">// 在 Contracts Layer
public record EmployeeDto(
    int Id,
    string Name,
    string Email,
    string Department,
    string Position,
    DateTime HireDate,
    string Status,
    int? SupervisorId,
    DateTime CreatedAt,
    DateTime? UpdatedAt);
</code></pre>
<hr />
<h2 id="module">7. Module 註冊</h2>
<h3 id="application-module">7.1 Application Module</h3>
<pre><code class="language-csharp">public static class WedaTemplateApplicationModule
{
    public static IServiceCollection AddApplication(
        this IServiceCollection services)
    {
        // 在此註冊 Application 專屬的 Service
        // Mediator 與 Validator 在 Weda.Core 中註冊

        return services;
    }
}
</code></pre>
<h3 id="assembly-marker">7.2 Assembly Marker</h3>
<pre><code class="language-csharp">// 用於 Assembly Scanning
public interface IApplicationMarker { }
</code></pre>
<hr />
<h2 id="section-1">快速參考</h2>
<h3 id="section-2">檔案命名慣例</h3>
<table>
<thead>
<tr>
<th>元件</th>
<th>模式</th>
<th>範例</th>
</tr>
</thead>
<tbody>
<tr>
<td>Command</td>
<td><code>{Action}{Aggregate}Command.cs</code></td>
<td><code>CreateEmployeeCommand.cs</code></td>
</tr>
<tr>
<td>Command Handler</td>
<td><code>{Action}{Aggregate}CommandHandler.cs</code></td>
<td><code>CreateEmployeeCommandHandler.cs</code></td>
</tr>
<tr>
<td>Validator</td>
<td><code>{Command}Validator.cs</code></td>
<td><code>CreateEmployeeCommandValidator.cs</code></td>
</tr>
<tr>
<td>Query</td>
<td><code>{Action}{Aggregate}Query.cs</code></td>
<td><code>GetEmployeeQuery.cs</code></td>
</tr>
<tr>
<td>Query Handler</td>
<td><code>{Action}{Aggregate}QueryHandler.cs</code></td>
<td><code>GetEmployeeQueryHandler.cs</code></td>
</tr>
<tr>
<td>Event Handler</td>
<td><code>{Event}Handler.cs</code></td>
<td><code>EmployeeCreatedEventHandler.cs</code></td>
</tr>
<tr>
<td>Mapper</td>
<td><code>{Aggregate}Mapper.cs</code></td>
<td><code>EmployeeMapper.cs</code></td>
</tr>
</tbody>
</table>
<h3 id="section-3">資料夾結構</h3>
<pre><code>Application/
└── {AggregateName}/
    ├── Commands/
    │   └── {ActionName}/
    │       ├── {Action}CommandHandler.cs
    │       └── {Action}CommandValidator.cs
    ├── Queries/
    │   └── {ActionName}/
    │       └── {Action}QueryHandler.cs
    ├── EventHandlers/
    │   └── {Event}Handler.cs
    └── Mapping/
        └── {Aggregate}Mapper.cs
</code></pre>
<hr />
<h2 id="section-4">相關資源</h2>
<ul>
<li><a href="GUIDE.md">GUIDE.md</a> - 學習指南總覽</li>
<li><a href="01-domain-layer.md">01-domain-layer.md</a> - Domain Layer 指南</li>
<li><a href="03-infrastructure-layer.md">03-infrastructure-layer.md</a> - Infrastructure Layer 指南</li>
<li><a href="https://github.com/martinothamar/Mediator">Mediator Documentation</a></li>
<li><a href="https://docs.fluentvalidation.net/">FluentValidation Documentation</a></li>
</ul>

    </article>
</body>
</html>